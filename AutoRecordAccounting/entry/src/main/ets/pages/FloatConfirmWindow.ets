import { PaymentInfo } from '../models/Transaction'
import { MoneyUtil, CategoryClassifier } from '../utils/CommonUtils'

@Entry
@Component
struct FloatConfirmWindow {
  @LocalStorageLink('paymentInfo') paymentInfo: PaymentInfo = new PaymentInfo()
  @LocalStorageLink('onConfirm') onConfirm: (confirmed: boolean, modifiedInfo?: any) => void = () => {}
  
  @State selectedCategory: string = ''
  @State remark: string = ''
  @State countdown: number = 5
  private timer: number = 0

  aboutToAppear() {
    this.selectedCategory = CategoryClassifier.classify(this.paymentInfo.merchant)
    
    // å¯åŠ¨å€’è®¡æ—¶
    this.timer = setInterval(() => {
      this.countdown--
      if (this.countdown <= 0) {
        this.handleIgnore()
      }
    }, 1000)
  }

  aboutToDisappear() {
    if (this.timer) {
      clearInterval(this.timer)
    }
  }

  build() {
    Column({ space: 16 }) {
      // æ ‡é¢˜
      Row() {
        Text('ğŸ’° æ£€æµ‹åˆ°æ”¯ä»˜')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
        
        Blank()
        
        Text(`${this.countdown}s`)
          .fontSize(14)
          .fontColor('#FF6B6B')
      }
      .width('100%')

      // é‡‘é¢æ˜¾ç¤º
      Text(MoneyUtil.format(this.paymentInfo.amount))
        .fontSize(32)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FF6B6B')

      // è¯¦æƒ…ä¿¡æ¯
      Column({ space: 8 }) {
        InfoRow({ label: 'å•†æˆ·', value: this.paymentInfo.merchant })
        InfoRow({ label: 'åˆ†ç±»', value: this.selectedCategory })
        InfoRow({ label: 'æ–¹å¼', value: this.paymentInfo.payMethod })
      }
      .width('100%')
      .padding(12)
      .backgroundColor('#F9F9F9')
      .borderRadius(8)

      // æ“ä½œæŒ‰é’®
      Row({ space: 12 }) {
        Button('å¿½ç•¥', { type: ButtonType.Capsule })
          .width(80)
          .height(36)
          .fontSize(14)
          .fontColor('#666')
          .backgroundColor('#E0E0E0')
          .onClick(() => this.handleIgnore())

        Button('ä¿®æ”¹', { type: ButtonType.Capsule })
          .width(80)
          .height(36)
          .fontSize(14)
          .fontColor('#FF6B6B')
          .backgroundColor('#FFE0E0')
          .onClick(() => this.handleModify())

        Button('ç¡®è®¤', { type: ButtonType.Capsule })
          .width(100)
          .height(36)
          .fontSize(14)
          .fontColor(Color.White)
          .backgroundColor('#FF6B6B')
          .onClick(() => this.handleConfirm())
      }
    }
    .width('100%')
    .height('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({ radius: 8, color: 'rgba(0,0,0,0.2)' })
  }

  private handleConfirm() {
    if (this.timer) {
      clearInterval(this.timer)
    }
    this.onConfirm(true, {
      ...this.paymentInfo,
      category: this.selectedCategory,
      remark: this.remark
    })
  }

  private handleIgnore() {
    if (this.timer) {
      clearInterval(this.timer)
    }
    this.onConfirm(false)
  }

  private handleModify() {
    // å±•å¼€ä¿®æ”¹é€‰é¡¹
    // è¿™é‡Œå¯ä»¥å±•å¼€åˆ†ç±»é€‰æ‹©å™¨ç­‰
  }
}

// ä¿¡æ¯è¡Œç»„ä»¶
@Component
struct InfoRow {
  @Prop label: string
  @Prop value: string

  build() {
    Row() {
      Text(this.label)
        .fontSize(14)
        .fontColor('#666')
      
      Blank()
      
      Text(this.value)
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333')
    }
    .width('100%')
  }
}