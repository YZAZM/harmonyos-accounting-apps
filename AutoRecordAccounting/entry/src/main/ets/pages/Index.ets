import { DatabaseManager } from '../database/DatabaseManager'
import { Transaction, TransactionType } from '../models/Transaction'
import { DateUtil, MoneyUtil } from '../utils/CommonUtils'
import { router } from '@kit.ArkUI'

@Entry
@Component
struct Index {
  @State todayExpense: number = 0
  @State todayIncome: number = 0
  @State monthExpense: number = 0
  @State monthIncome: number = 0
  @State recentTransactions: Transaction[] = []
  @State isLoading: boolean = true

  aboutToAppear() {
    this.loadData()
  }

  async loadData() {
    this.isLoading = true
    try {
      // Âä†ËΩΩ‰ªäÊó•Êî∂ÊîØ
      const todayStart = DateUtil.getTodayStart()
      const todayEnd = DateUtil.getTodayEnd()
      const todayTransactions = await DatabaseManager.getInstance().queryTransactions(todayStart, todayEnd)
      
      this.todayExpense = todayTransactions
        .filter(t => t.type === TransactionType.EXPENSE)
        .reduce((sum, t) => sum + t.amount, 0)
      this.todayIncome = todayTransactions
        .filter(t => t.type === TransactionType.INCOME)
        .reduce((sum, t) => sum + t.amount, 0)

      // Âä†ËΩΩÊú¨ÊúàÊî∂ÊîØ
      const now = new Date()
      const monthStats = await DatabaseManager.getInstance().getMonthlyStats(now.getFullYear(), now.getMonth() + 1)
      this.monthExpense = monthStats.expense
      this.monthIncome = monthStats.income

      // Âä†ËΩΩÊúÄËøë‰∫§Êòì
      this.recentTransactions = await DatabaseManager.getInstance().queryTransactions(undefined, undefined, undefined, undefined)
      this.recentTransactions = this.recentTransactions.slice(0, 5)

    } catch (err) {
      console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', err)
    }
    this.isLoading = false
  }

  build() {
    Column() {
      // Ê†áÈ¢òÊ†è
      Row() {
        Text('Ëá™Âä®ËÆ∞Ë¥¶')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
        
        Blank()
        
        Button({ type: ButtonType.Circle }) {
          Text('+')
            .fontSize(24)
            .fontColor(Color.White)
        }
        .width(44)
        .height(44)
        .backgroundColor('#FF6B6B')
        .onClick(() => {
          router.pushUrl({ url: 'pages/AddTransactionPage' })
        })
      }
      .width('100%')
      .padding(16)

      Scroll() {
        Column({ space: 16 }) {
          // ‰ªäÊó•Ê¶ÇËßàÂç°Áâá
          TodayCard({
            expense: this.todayExpense,
            income: this.todayIncome
          })

          // Êú¨ÊúàÊ¶ÇËßà
          MonthCard({
            expense: this.monthExpense,
            income: this.monthIncome
          })

          // ÊúÄËøë‰∫§Êòì
          RecentTransactions({ transactions: this.recentTransactions })
        }
        .padding(16)
      }
      .layoutWeight(1)

      // Â∫ïÈÉ®ÂØºËà™
      BottomNavigation()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}

// ‰ªäÊó•Ê¶ÇËßàÂç°Áâá
@Component
struct TodayCard {
  @Prop expense: number
  @Prop income: number

  build() {
    Column({ space: 12 }) {
      Text('‰ªäÊó•Êî∂ÊîØ')
        .fontSize(16)
        .fontColor('#666')
        .alignSelf(ItemAlign.Start)

      Row() {
        Column({ space: 4 }) {
          Text('ÊîØÂá∫')
            .fontSize(14)
            .fontColor('#999')
          Text(MoneyUtil.format(this.expense))
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF6B6B')
        }
        .layoutWeight(1)

        Divider()
          .vertical(true)
          .height(40)
          .color('#E0E0E0')

        Column({ space: 4 }) {
          Text('Êî∂ÂÖ•')
            .fontSize(14)
            .fontColor('#999')
          Text(MoneyUtil.format(this.income))
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#4CAF50')
        }
        .layoutWeight(1)
      }
      .width('100%')
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({ radius: 4, color: 'rgba(0,0,0,0.1)' })
  }
}

// Êú¨ÊúàÊ¶ÇËßàÂç°Áâá
@Component
struct MonthCard {
  @Prop expense: number
  @Prop income: number

  build() {
    Column({ space: 12 }) {
      Row() {
        Text('Êú¨ÊúàÊî∂ÊîØ')
          .fontSize(16)
          .fontColor('#666')
        
        Blank()
        
        Text('Êü•ÁúãÊõ¥Â§ö >')
          .fontSize(14)
          .fontColor('#999')
      }
      .width('100%')

      // ËøõÂ∫¶Êù°Â±ïÁ§∫
      Column({ space: 8 }) {
        Row() {
          Text('ÊîØÂá∫')
            .fontSize(14)
            .fontColor('#666')
          Text(MoneyUtil.format(this.expense))
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#FF6B6B')
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)

        Progress({ value: this.expense, total: Math.max(this.expense + this.income, 1), type: ProgressType.Linear })
          .width('100%')
          .color('#FF6B6B')
          .backgroundColor('#FFE0E0')

        Row() {
          Text('Êî∂ÂÖ•')
            .fontSize(14)
            .fontColor('#666')
          Text(MoneyUtil.format(this.income))
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#4CAF50')
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)

        Progress({ value: this.income, total: Math.max(this.expense + this.income, 1), type: ProgressType.Linear })
          .width('100%')
          .color('#4CAF50')
          .backgroundColor('#E0F2E0')
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({ radius: 4, color: 'rgba(0,0,0,0.1)' })
  }
}

// ÊúÄËøë‰∫§ÊòìÂàóË°®
@Component
struct RecentTransactions {
  @Prop transactions: Transaction[]

  build() {
    Column({ space: 12 }) {
      Row() {
        Text('ÊúÄËøë‰∫§Êòì')
          .fontSize(16)
          .fontColor('#666')
        
        Blank()
        
        Text('Êü•ÁúãÂÖ®ÈÉ® >')
          .fontSize(14)
          .fontColor('#999')
      }
      .width('100%')

      if (this.transactions.length === 0) {
        Column() {
          Text('ÊöÇÊó†‰∫§ÊòìËÆ∞ÂΩï')
            .fontSize(14)
            .fontColor('#999')
        }
        .padding(32)
        .width('100%')
      } else {
        Column({ space: 8 }) {
          ForEach(this.transactions, (transaction: Transaction) => {
            TransactionItem({ transaction: transaction })
          })
        }
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({ radius: 4, color: 'rgba(0,0,0,0.1)' })
  }
}

// ‰∫§ÊòìÈ°π
@Component
struct TransactionItem {
  @Prop transaction: Transaction

  build() {
    Row() {
      // ÂõæÊ†á
      Text(this.getCategoryIcon())
        .fontSize(24)
        .margin({ right: 12 })

      // ‰ø°ÊÅØ
      Column({ space: 4 }) {
        Text(this.transaction.merchant || this.transaction.category)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
        Text(DateUtil.formatDateTime(this.transaction.transactionTime))
          .fontSize(12)
          .fontColor('#999')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // ÈáëÈ¢ù
      Text(MoneyUtil.formatWithSign(this.transaction.amount, this.transaction.type))
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.transaction.type === 1 ? '#4CAF50' : '#FF6B6B')
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#F9F9F9')
    .borderRadius(8)
  }

  private getCategoryIcon(): string {
    const iconMap: Record<string, string> = {
      'È§êÈ•Æ': 'üçî',
      '‰∫§ÈÄö': 'üöó',
      'Ë¥≠Áâ©': 'üõçÔ∏è',
      'Â®±‰πê': 'üéÆ',
      'Â±Ö‰Ωè': 'üè†',
      'ÂåªÁñó': 'üè•',
      'ÊïôËÇ≤': 'üìö',
      'ÂÖ∂‰ªñ': 'üì¶',
      'Â∑•ËµÑ': 'üí∞',
      'Â•ñÈáë': 'üéÅ',
      'ÊäïËµÑ': 'üìà',
      'ÂÖºËÅå': 'üíº'
    }
    return iconMap[this.transaction.category] || 'üí∞'
  }
}

// Â∫ïÈÉ®ÂØºËà™
@Component
struct BottomNavigation {
  build() {
    Row() {
      NavItem({ icon: 'üè†', label: 'È¶ñÈ°µ', isActive: true, url: '' })
      NavItem({ icon: 'üìä', label: 'ÁªüËÆ°', isActive: false, url: 'pages/StatisticsPage' })
      NavItem({ icon: 'üìã', label: 'Ë¥¶Âçï', isActive: false, url: 'pages/TransactionListPage' })
      NavItem({ icon: '‚öôÔ∏è', label: 'ËÆæÁΩÆ', isActive: false, url: 'pages/SettingsPage' })
    }
    .width('100%')
    .height(64)
    .backgroundColor(Color.White)
    .shadow({ radius: 8, color: 'rgba(0,0,0,0.1)', offsetY: -2 })
  }
}

// ÂØºËà™È°π
@Component
struct NavItem {
  @Prop icon: string
  @Prop label: string
  @Prop isActive: boolean
  @Prop url: string

  build() {
    Column({ space: 4 }) {
      Text(this.icon)
        .fontSize(20)
      Text(this.label)
        .fontSize(12)
        .fontColor(this.isActive ? '#FF6B6B' : '#999')
    }
    .layoutWeight(1)
    .onClick(() => {
      if (this.url && !this.isActive) {
        router.pushUrl({ url: this.url })
      }
    })
  }
}