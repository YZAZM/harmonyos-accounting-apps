import { router } from '@kit.ArkUI'
import { preferences } from '@kit.ArkData'
import { DEFAULT_SETTINGS, STORAGE_KEYS } from '../constants/AppConstants'

@Entry
@Component
struct SettingsPage {
  @State autoRecordEnabled: boolean = false
  @State floatWindowEnabled: boolean = true
  @State vibrationEnabled: boolean = true
  @State soundEnabled: boolean = false
  private preference: preferences.Preferences | null = null

  aboutToAppear() {
    this.loadSettings()
  }

  async loadSettings() {
    try {
      this.preference = preferences.getPreferencesSync(getContext(), { name: 'app_settings' })
      
      this.autoRecordEnabled = this.preference.getSync(STORAGE_KEYS.AUTO_RECORD_ENABLED, DEFAULT_SETTINGS.autoRecordEnabled) as boolean
      this.floatWindowEnabled = this.preference.getSync('float_window_enabled', DEFAULT_SETTINGS.floatWindowEnabled) as boolean
      this.vibrationEnabled = this.preference.getSync('vibration_enabled', DEFAULT_SETTINGS.vibrationEnabled) as boolean
      this.soundEnabled = this.preference.getSync('sound_enabled', DEFAULT_SETTINGS.soundEnabled) as boolean
    } catch (err) {
      console.error('Âä†ËΩΩËÆæÁΩÆÂ§±Ë¥•:', err)
    }
  }

  async saveSettings() {
    if (!this.preference) return

    try {
      await this.preference.put(STORAGE_KEYS.AUTO_RECORD_ENABLED, this.autoRecordEnabled)
      await this.preference.put('float_window_enabled', this.floatWindowEnabled)
      await this.preference.put('vibration_enabled', this.vibrationEnabled)
      await this.preference.put('sound_enabled', this.soundEnabled)
      await this.preference.flush()
    } catch (err) {
      console.error('‰øùÂ≠òËÆæÁΩÆÂ§±Ë¥•:', err)
    }
  }

  build() {
    Column() {
      // Ê†áÈ¢òÊ†è
      Row() {
        Button() {
          Text('‚Üê')
            .fontSize(24)
            .fontColor('#333')
        }
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          router.back()
        })

        Text('ËÆæÁΩÆ')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Blank()
          .width(44)
      }
      .width('100%')
      .padding(16)

      Scroll() {
        Column({ space: 16 }) {
          // Ëá™Âä®ËÆ∞Ë¥¶ËÆæÁΩÆÁªÑ
          SettingsGroup({ title: 'Ëá™Âä®ËÆ∞Ë¥¶' }) {
            ToggleSettingItem({
              icon: 'ü§ñ',
              title: 'Ëá™Âä®ËØÜÂà´ÊîØ‰ªò',
              subtitle: 'ÂºÄÂêØÂêéËá™Âä®ÁõëÂê¨ÊîØ‰ªòÈ°µÈù¢',
              isOn: this.autoRecordEnabled,
              onChange: (value) => {
                this.autoRecordEnabled = value
                this.saveSettings()
              }
            })

            ToggleSettingItem({
              icon: 'üîî',
              title: 'ÊÇ¨ÊµÆÁ°ÆËÆ§Á™ó',
              subtitle: 'ÊîØ‰ªòÂêéÊòæÁ§∫Á°ÆËÆ§ÂºπÁ™ó',
              isOn: this.floatWindowEnabled,
              onChange: (value) => {
                this.floatWindowEnabled = value
                this.saveSettings()
              }
            })
          }

          // ÈÄöÁü•ËÆæÁΩÆÁªÑ
          SettingsGroup({ title: 'ÈÄöÁü•' }) {
            ToggleSettingItem({
              icon: 'üì≥',
              title: 'ÈúáÂä®ÊèêÈÜí',
              subtitle: 'ËÆ∞Ë¥¶ÊàêÂäüÊó∂ÈúáÂä®',
              isOn: this.vibrationEnabled,
              onChange: (value) => {
                this.vibrationEnabled = value
                this.saveSettings()
              }
            })

            ToggleSettingItem({
              icon: 'üîä',
              title: 'Â£∞Èü≥ÊèêÈÜí',
              subtitle: 'ËÆ∞Ë¥¶ÊàêÂäüÊó∂Êí≠ÊîæÊèêÁ§∫Èü≥',
              isOn: this.soundEnabled,
              onChange: (value) => {
                this.soundEnabled = value
                this.saveSettings()
              }
            })
          }

          // Êï∞ÊçÆÁÆ°ÁêÜÁªÑ
          SettingsGroup({ title: 'Êï∞ÊçÆÁÆ°ÁêÜ' }) {
            NavigationSettingItem({
              icon: 'üíæ',
              title: 'Êï∞ÊçÆÂ§á‰ªΩ',
              subtitle: 'ÂØºÂá∫Ë¥¶ÂçïÊï∞ÊçÆÂà∞Êú¨Âú∞',
              onClick: () => {
                // ÂØºÂá∫Êï∞ÊçÆ
              }
            })

            NavigationSettingItem({
              icon: 'üì•',
              title: 'Êï∞ÊçÆÊÅ¢Â§ç',
              subtitle: '‰ªéÂ§á‰ªΩÊñá‰ª∂ÊÅ¢Â§çÊï∞ÊçÆ',
              onClick: () => {
                // ÂØºÂÖ•Êï∞ÊçÆ
              }
            })

            NavigationSettingItem({
              icon: 'üóëÔ∏è',
              title: 'Ê∏ÖÈô§Êï∞ÊçÆ',
              subtitle: 'Âà†Èô§ÊâÄÊúâË¥¶ÂçïÊï∞ÊçÆ',
              onClick: () => {
                // Ê∏ÖÈô§Êï∞ÊçÆ
              }
            })
          }

          // ÂÖ≥‰∫éÁªÑ
          SettingsGroup({ title: 'ÂÖ≥‰∫é' }) {
            InfoSettingItem({
              icon: '‚ÑπÔ∏è',
              title: 'ÁâàÊú¨',
              value: '1.0.0'
            })

            NavigationSettingItem({
              icon: 'üìñ',
              title: '‰ΩøÁî®Â∏ÆÂä©',
              subtitle: '‰∫ÜËß£Â¶Ç‰Ωï‰ΩøÁî®Ëá™Âä®ËÆ∞Ë¥¶',
              onClick: () => {
                // ÊâìÂºÄÂ∏ÆÂä©
              }
            })

            NavigationSettingItem({
              icon: 'üìß',
              title: 'ÊÑèËßÅÂèçÈ¶à',
              subtitle: 'ÂêëÊàë‰ª¨ÂèçÈ¶àÈóÆÈ¢òÂíåÂª∫ËÆÆ',
              onClick: () => {
                // ÊâìÂºÄÂèçÈ¶à
              }
            })
          }
        }
        .padding(16)
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}

// ËÆæÁΩÆÁªÑ
@Component
struct SettingsGroup {
  @BuilderParam content: () => void
  @Prop title: string

  build() {
    Column({ space: 8 }) {
      Text(this.title)
        .fontSize(14)
        .fontColor('#999')
        .alignSelf(ItemAlign.Start)
        .margin({ left: 8 })

      Column() {
        this.content()
      }
      .width('100%')
      .backgroundColor(Color.White)
      .borderRadius(12)
      .shadow({ radius: 4, color: 'rgba(0,0,0,0.05)' })
    }
    .width('100%')
  }
}

// ÂºÄÂÖ≥ËÆæÁΩÆÈ°π
@Component
struct ToggleSettingItem {
  @Prop icon: string
  @Prop title: string
  @Prop subtitle: string
  @Prop isOn: boolean
  onChange: (value: boolean) => void = () => {}

  build() {
    Row() {
      Text(this.icon)
        .fontSize(24)
        .margin({ right: 12 })

      Column({ space: 4 }) {
        Text(this.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
        Text(this.subtitle)
          .fontSize(12)
          .fontColor('#999')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      Toggle({ type: ToggleType.Switch, isOn: this.isOn })
        .onChange((value) => {
          this.onChange(value)
        })
    }
    .width('100%')
    .height(64)
    .padding(12)
  }
}

// ÂØºËà™ËÆæÁΩÆÈ°π
@Component
struct NavigationSettingItem {
  @Prop icon: string
  @Prop title: string
  @Prop subtitle: string
  onClick: () => void = () => {}

  build() {
    Row() {
      Text(this.icon)
        .fontSize(24)
        .margin({ right: 12 })

      Column({ space: 4 }) {
        Text(this.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
        Text(this.subtitle)
          .fontSize(12)
          .fontColor('#999')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      Text('>')
        .fontSize(18)
        .fontColor('#CCC')
    }
    .width('100%')
    .height(64)
    .padding(12)
    .onClick(this.onClick)
  }
}

// ‰ø°ÊÅØËÆæÁΩÆÈ°π
@Component
struct InfoSettingItem {
  @Prop icon: string
  @Prop title: string
  @Prop value: string

  build() {
    Row() {
      Text(this.icon)
        .fontSize(24)
        .margin({ right: 12 })

      Text(this.title)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .layoutWeight(1)

      Text(this.value)
        .fontSize(14)
        .fontColor('#999')
    }
    .width('100%')
    .height(56)
    .padding(12)
  }
}