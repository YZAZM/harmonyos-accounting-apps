import { router } from '@kit.ArkUI';
import { TransactionDao, Transaction, TransactionType, CategoryDao, Category } from '../data/Dao';
import { SmartCategorizer } from '../utils/SmartCategorizer';
import { DateTimeUtil } from '../utils/Utils';

@Entry
@Component
struct AddTransaction {
  @State amount: string = '';
  @State type: TransactionType = TransactionType.EXPENSE;
  @State category: string = 'é¤é¥®';
  @State merchant: string = '';
  @State remark: string = '';
  @State selectedDate: Date = new Date();
  @State showDatePicker: boolean = false;
  @State expenseCategories: Category[] = [];
  @State incomeCategories: Category[] = [];
  @State isLoading: boolean = true;

  private amountButtons: string[] = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '.', '0', 'âŒ«'];

  async aboutToAppear() {
    this.expenseCategories = await CategoryDao.queryAll(TransactionType.EXPENSE);
    this.incomeCategories = await CategoryDao.queryAll(TransactionType.INCOME);
    if (this.expenseCategories.length > 0) {
      this.category = this.expenseCategories[0].name;
    }
    this.isLoading = false;
  }

  // æ™ºèƒ½è¯†åˆ«å•†æˆ·åˆ†ç±»
  onMerchantChange(value: string) {
    this.merchant = value;
    if (value.length > 1) {
      const detectedCategory = SmartCategorizer.categorize(value);
      if (detectedCategory !== 'å…¶ä»–') {
        this.category = detectedCategory;
      }
    }
  }

  // ä¿å­˜äº¤æ˜“
  async saveTransaction() {
    if (!this.amount || parseFloat(this.amount) <= 0) {
      // æç¤ºè¯·è¾“å…¥é‡‘é¢
      return;
    }

    const transaction: Transaction = {
      amount: parseFloat(this.amount),
      type: this.type,
      category: this.category,
      merchant: this.merchant,
      transactionTime: this.selectedDate.getTime(),
      remark: this.remark,
      sourceApp: 'manual'
    };

    const id = await TransactionDao.add(transaction);
    if (id > 0) {
      router.back();
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('Ã—')
          .fontSize(28)
          .fontColor('#666666')
          .onClick(() => {
            router.back();
          })
        
        Text(this.type === TransactionType.EXPENSE ? 'è®°æ”¯å‡º' : 'è®°æ”¶å…¥')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1A1A1A')
        
        Text('ä¿å­˜')
          .fontSize(16)
          .fontColor('#4CAF50')
          .onClick(() => {
            this.saveTransaction();
          })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .justifyContent(FlexAlign.SpaceBetween)

      // æ”¶æ”¯ç±»å‹åˆ‡æ¢
      Row({ space: 0 }) {
        Column() {
          Text('æ”¯å‡º')
            .fontSize(15)
            .fontWeight(this.type === TransactionType.EXPENSE ? FontWeight.Bold : FontWeight.Normal)
            .fontColor(this.type === TransactionType.EXPENSE ? '#FF5722' : '#999999')
            .height(40)
            .onClick(() => {
              this.type = TransactionType.EXPENSE;
              if (this.expenseCategories.length > 0) {
                this.category = this.expenseCategories[0].name;
              }
            })
          
          if (this.type === TransactionType.EXPENSE) {
            Row()
              .width(24)
              .height(3)
              .backgroundColor('#FF5722')
              .borderRadius(2)
          }
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Center)

        Column() {
          Text('æ”¶å…¥')
            .fontSize(15)
            .fontWeight(this.type === TransactionType.INCOME ? FontWeight.Bold : FontWeight.Normal)
            .fontColor(this.type === TransactionType.INCOME ? '#4CAF50' : '#999999')
            .height(40)
            .onClick(() => {
              this.type = TransactionType.INCOME;
              if (this.incomeCategories.length > 0) {
                this.category = this.incomeCategories[0].name;
              }
            })
          
          if (this.type === TransactionType.INCOME) {
            Row()
              .width(24)
              .height(3)
              .backgroundColor('#4CAF50')
              .borderRadius(2)
          }
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
      .margin({ top: 8, bottom: 16 })

      // é‡‘é¢æ˜¾ç¤º
      Row() {
        Text('Â¥')
          .fontSize(32)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1A1A1A')
          .margin({ right: 8 })
        
        Text(this.amount || '0.00')
          .fontSize(48)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')
      }
      .width('100%')
      .height(80)
      .justifyContent(FlexAlign.Center)
      .margin({ bottom: 24 })

      // åˆ†ç±»é€‰æ‹©
      Column({ space: 12 }) {
        Text('é€‰æ‹©åˆ†ç±»')
          .fontSize(14)
          .fontColor('#666666')
          .alignSelf(ItemAlign.Start)
        
        if (!this.isLoading) {
          Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
            ForEach(this.type === TransactionType.EXPENSE ? this.expenseCategories : this.incomeCategories, (item: Category) => {
              Column({ space: 4 }) {
                Text(item.icon)
                  .fontSize(24)
                
                Text(item.name)
                  .fontSize(12)
                  .fontColor(this.category === item.name ? '#FFFFFF' : '#666666')
              }
              .width(64)
              .height(64)
              .backgroundColor(this.category === item.name ? (this.type === TransactionType.EXPENSE ? '#FF5722' : '#4CAF50') : '#F5F5F5')
              .borderRadius(12)
              .margin(6)
              .onClick(() => {
                this.category = item.name;
              })
            }, (item: Category) => item.id?.toString())
          }
          .width('100%')
        }
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .margin({ left: 16, right: 16, bottom: 16 })

      // è¯¦ç»†ä¿¡æ¯è¾“å…¥
      Column({ space: 16 }) {
        // å•†æˆ·
        Row({ space: 12 }) {
          Text('å•†æˆ·')
            .fontSize(14)
            .fontColor('#666666')
            .width(60)
          
          TextInput({ placeholder: 'é€‰å¡«ï¼Œå¦‚ï¼šæ˜Ÿå·´å…‹', text: $$this.merchant })
            .fontSize(14)
            .placeholderColor('#CCCCCC')
            .backgroundColor('#F5F5F5')
            .borderRadius(8)
            .padding(12)
            .onChange((value) => {
              this.onMerchantChange(value);
            })
        }
        .width('100%')

        // æ—¶é—´
        Row({ space: 12 }) {
          Text('æ—¶é—´')
            .fontSize(14)
            .fontColor('#666666')
            .width(60)
          
          Row() {
            Text(DateTimeUtil.formatDateTime(this.selectedDate.getTime()))
              .fontSize(14)
              .fontColor('#1A1A1A')
            
            Blank()
            
            Text('ğŸ“…')
              .fontSize(16)
          }
          .width('100%')
          .height(44)
          .backgroundColor('#F5F5F5')
          .borderRadius(8)
          .padding({ left: 12, right: 12 })
          .onClick(() => {
            this.showDatePicker = true;
          })
        }
        .width('100%')

        // å¤‡æ³¨
        Row({ space: 12 }) {
          Text('å¤‡æ³¨')
            .fontSize(14)
            .fontColor('#666666')
            .width(60)
          
          TextInput({ placeholder: 'æ·»åŠ å¤‡æ³¨...', text: $$this.remark })
            .fontSize(14)
            .placeholderColor('#CCCCCC')
            .backgroundColor('#F5F5F5')
            .borderRadius(8)
            .padding(12)
        }
        .width('100%')
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .margin({ left: 16, right: 16 })

      Blank()

      // æ•°å­—é”®ç›˜
      Grid() {
        ForEach(this.amountButtons, (btn: string, index: number) => {
          GridItem() {
            Column() {
              Text(btn)
                .fontSize(btn === 'âŒ«' ? 20 : 24)
                .fontColor('#1A1A1A')
            }
            .width('100%')
            .height(64)
            .backgroundColor('#FFFFFF')
            .border({ width: 0.5, color: '#E0E0E0' })
            .justifyContent(FlexAlign.Center)
            .onClick(() => {
              this.onNumberClick(btn);
            })
          }
        }, (btn: string) => btn)
      }
      .columnsTemplate('1fr 1fr 1fr')
      .rowsTemplate('1fr 1fr 1fr 1fr')
      .width('100%')
      .height(256)
      .backgroundColor('#F5F5F5')

      // æ—¥æœŸé€‰æ‹©å™¨å¼¹çª—
      if (this.showDatePicker) {
        Column() {
          DatePicker({
            selected: this.selectedDate
          })
            .onDateChange((value: Date) => {
              this.selectedDate = value;
            })
          
          Row({ space: 16 }) {
            Button('å–æ¶ˆ')
              .fontSize(16)
              .fontColor('#666666')
              .backgroundColor('#F5F5F5')
              .onClick(() => {
                this.showDatePicker = false;
              })
            
            Button('ç¡®å®š')
              .fontSize(16)
              .fontColor('#FFFFFF')
              .backgroundColor('#4CAF50')
              .onClick(() => {
                this.showDatePicker = false;
              })
          }
          .margin({ top: 16 })
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#FFFFFF')
        .borderRadius({ topLeft: 20, topRight: 20 })
        .position({ x: 0, y: '100%' })
        .translate({ y: '-100%' })
        .animation({
          duration: 300,
          curve: Curve.EaseOut
        })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  private onNumberClick(btn: string) {
    if (btn === 'âŒ«') {
      if (this.amount.length > 0) {
        this.amount = this.amount.slice(0, -1);
      }
    } else if (btn === '.') {
      if (!this.amount.includes('.')) {
        this.amount += btn;
      }
    } else {
      if (this.amount.length < 10) {
        if (this.amount === '0' && btn !== '.') {
          this.amount = btn;
        } else {
          this.amount += btn;
        }
      }
    }
  }
}
