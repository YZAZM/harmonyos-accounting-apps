import { router } from '@kit.ArkUI';
import { TransactionDao, Transaction, TransactionType, CategoryDao, Category } from '../data/Dao';
import { DateTimeUtil, MoneyUtil } from '../utils/Utils';

@Entry
@Component
struct Index {
  @State todayExpense: number = 0;
  @State todayIncome: number = 0;
  @State monthExpense: number = 0;
  @State monthIncome: number = 0;
  @State recentTransactions: Transaction[] = [];
  @State isLoading: boolean = true;
  @State selectedTab: number = 0;

  private tabs: string[] = ['é¦–é¡µ', 'è´¦å•', 'ç»Ÿè®¡', 'æˆ‘çš„'];

  aboutToAppear() {
    this.loadData();
  }

  async loadData() {
    this.isLoading = true;
    
    // åŠ è½½ä»Šæ—¥æ•°æ®
    const todaySummary = await TransactionDao.getTodaySummary();
    this.todayExpense = todaySummary.expense;
    this.todayIncome = todaySummary.income;

    // åŠ è½½æœ¬æœˆæ•°æ®
    const now = new Date();
    const monthSummary = await TransactionDao.getMonthSummary(now.getFullYear(), now.getMonth() + 1);
    this.monthExpense = monthSummary.expense;
    this.monthIncome = monthSummary.income;

    // åŠ è½½æœ€è¿‘5ç¬”äº¤æ˜“
    this.recentTransactions = await TransactionDao.queryAll(5);

    this.isLoading = false;
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('è‡ªåŠ¨è®°è´¦')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')
        
        Blank()
        
        Button() {
          Text('+ è®°ä¸€ç¬”')
            .fontSize(14)
            .fontColor('#FFFFFF')
        }
        .type(ButtonType.Capsule)
        .backgroundColor('#4CAF50')
        .onClick(() => {
          router.pushUrl({ url: 'pages/AddTransaction' });
        })
      }
      .width('100%')
      .height(56)
      .padding({ left: 20, right: 20 })

      if (this.isLoading) {
        LoadingProgress()
          .width(40)
          .height(40)
          .margin({ top: 100 })
      } else {
        Scroll() {
          Column({ space: 16 }) {
            // ä»Šæ—¥æ”¶æ”¯å¡ç‰‡
            this.TodayCard()

            // æœ¬æœˆæ¦‚è§ˆå¡ç‰‡
            this.MonthCard()

            // æœ€è¿‘äº¤æ˜“åˆ—è¡¨
            this.RecentTransactionsCard()
          }
          .width('100%')
          .padding(16)
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  TodayCard() {
    Column({ space: 12 }) {
      Text('ä»Šæ—¥æ”¶æ”¯')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#666666')
        .alignSelf(ItemAlign.Start)

      Row() {
        // æ”¯å‡º
        Column({ space: 4 }) {
          Text('æ”¯å‡º')
            .fontSize(12)
            .fontColor('#999999')
          Text(`Â¥${MoneyUtil.formatInt(this.todayExpense)}`)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

        Divider()
          .vertical(true)
          .height(40)
          .color('#E0E0E0')

        // æ”¶å…¥
        Column({ space: 4 }) {
          Text('æ”¶å…¥')
            .fontSize(12)
            .fontColor('#999999')
          Text(`Â¥${MoneyUtil.formatInt(this.todayIncome)}`)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.End)
      }
      .width('100%')
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: 'rgba(0,0,0,0.08)',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder
  MonthCard() {
    Column({ space: 12 }) {
      Row() {
        Text('æœ¬æœˆæ¦‚è§ˆ')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#666666')
        
        Blank()
        
        Text(DateTimeUtil.formatDateTime(Date.now(), 'yyyyå¹´MMæœˆ'))
          .fontSize(12)
          .fontColor('#999999')
      }
      .width('100%')

      // ç»“ä½™
      Row() {
        Text('æœ¬æœˆç»“ä½™')
          .fontSize(12)
          .fontColor('#999999')
        
        Text(`Â¥${MoneyUtil.formatInt(this.monthIncome - this.monthExpense)}`)
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.monthIncome >= this.monthExpense ? '#4CAF50' : '#FF5722')
      }
      .width('100%')
      .margin({ top: 8, bottom: 8 })

      // æ”¶æ”¯è¿›åº¦æ¡
      Row({ space: 8 }) {
        Text('æ”¯å‡º')
          .fontSize(11)
          .fontColor('#999999')
          .width(40)
        
        Stack() {
          Row()
            .width('100%')
            .height(8)
            .backgroundColor('#F0F0F0')
            .borderRadius(4)
          
          Row()
            .width(Math.min(this.monthExpense / Math.max(this.monthIncome + this.monthExpense, 1) * 100 + '%'))
            .height(8)
            .backgroundColor('#FF5722')
            .borderRadius(4)
            .alignSelf(ItemAlign.Start)
        }
        .width('60%')
        .height(8)
        
        Text(`Â¥${MoneyUtil.formatInt(this.monthExpense)}`)
          .fontSize(11)
          .fontColor('#666666')
          .layoutWeight(1)
          .textAlign(TextAlign.End)
      }
      .width('100%')

      Row({ space: 8 }) {
        Text('æ”¶å…¥')
          .fontSize(11)
          .fontColor('#999999')
          .width(40)
        
        Stack() {
          Row()
            .width('100%')
            .height(8)
            .backgroundColor('#F0F0F0')
            .borderRadius(4)
          
          Row()
            .width(Math.min(this.monthIncome / Math.max(this.monthIncome + this.monthExpense, 1) * 100 + '%'))
            .height(8)
            .backgroundColor('#4CAF50')
            .borderRadius(4)
            .alignSelf(ItemAlign.Start)
        }
        .width('60%')
        .height(8)
        
        Text(`Â¥${MoneyUtil.formatInt(this.monthIncome)}`)
          .fontSize(11)
          .fontColor('#666666')
          .layoutWeight(1)
          .textAlign(TextAlign.End)
      }
      .width('100%')
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: 'rgba(0,0,0,0.08)',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder
  RecentTransactionsCard() {
    Column({ space: 12 }) {
      Row() {
        Text('æœ€è¿‘äº¤æ˜“')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#666666')
        
        Blank()
        
        Text('æŸ¥çœ‹å…¨éƒ¨ >')
          .fontSize(12)
          .fontColor('#4CAF50')
          .onClick(() => {
            router.pushUrl({ url: 'pages/TransactionList' });
          })
      }
      .width('100%')

      if (this.recentTransactions.length === 0) {
        Column({ space: 8 }) {
          Text('æš‚æ— äº¤æ˜“è®°å½•')
            .fontSize(14)
            .fontColor('#999999')
          Text('ç‚¹å‡»å³ä¸Šè§’"è®°ä¸€ç¬”"å¼€å§‹è®°è´¦')
            .fontSize(12)
            .fontColor('#CCCCCC')
        }
        .width('100%')
        .padding(40)
      } else {
        Column({ space: 0 }) {
          ForEach(this.recentTransactions, (transaction: Transaction, index: number) => {
            this.TransactionItem(transaction, index === this.recentTransactions.length - 1)
          }, (transaction: Transaction) => transaction.id?.toString())
        }
        .width('100%')
        .backgroundColor('#FFFFFF')
        .borderRadius(12)
        .padding({ left: 16, right: 16 })
      }
    }
    .width('100%')
  }

  @Builder
  TransactionItem(transaction: Transaction, isLast: boolean) {
    Row() {
      // å›¾æ ‡
      Column() {
        Text(this.getCategoryIcon(transaction.category))
          .fontSize(24)
      }
      .width(48)
      .height(48)
      .backgroundColor('#F5F5F5')
      .borderRadius(24)
      .justifyContent(FlexAlign.Center)

      // ä¿¡æ¯
      Column({ space: 4 }) {
        Text(transaction.merchant || transaction.category)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1A1A1A')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
        
        Row({ space: 8 }) {
          Text(transaction.category)
            .fontSize(11)
            .fontColor('#FFFFFF')
            .backgroundColor(this.getCategoryColor(transaction.category))
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(4)
          
          Text(DateTimeUtil.formatTime(transaction.transactionTime))
            .fontSize(11)
            .fontColor('#999999')
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 12 })

      // é‡‘é¢
      Text(MoneyUtil.formatWithSymbol(transaction.amount, transaction.type))
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(transaction.type === TransactionType.EXPENSE ? '#1A1A1A' : '#4CAF50')
    }
    .width('100%')
    .height(72)
    .border({
      width: { bottom: isLast ? 0 : 1 },
      color: '#F0F0F0'
    })
  }

  private getCategoryIcon(category: string): string {
    const iconMap: Map<string, string> = new Map([
      ['é¤é¥®', 'ğŸ½ï¸'],
      ['äº¤é€š', 'ğŸš—'],
      ['è´­ç‰©', 'ğŸ›ï¸'],
      ['å¨±ä¹', 'ğŸ®'],
      ['å±…ä½', 'ğŸ '],
      ['åŒ»ç–—', 'ğŸ¥'],
      ['æ•™è‚²', 'ğŸ“š'],
      ['å·¥èµ„', 'ğŸ’°'],
      ['å¥–é‡‘', 'ğŸ'],
      ['æŠ•èµ„', 'ğŸ“ˆ'],
      ['å…¶ä»–', 'ğŸ“‹']
    ]);
    return iconMap.get(category) || 'ğŸ“‹';
  }

  private getCategoryColor(category: string): string {
    const colorMap: Map<string, string> = new Map([
      ['é¤é¥®', '#FF6B6B'],
      ['äº¤é€š', '#4ECDC4'],
      ['è´­ç‰©', '#45B7D1'],
      ['å¨±ä¹', '#96CEB4'],
      ['å±…ä½', '#FFEAA7'],
      ['åŒ»ç–—', '#DDA0DD'],
      ['æ•™è‚²', '#98D8C8'],
      ['å·¥èµ„', '#4CAF50'],
      ['å¥–é‡‘', '#FFD93D'],
      ['æŠ•èµ„', '#6C5CE7'],
      ['å…¶ä»–', '#A0A0A0']
    ]);
    return colorMap.get(category) || '#A0A0A0';
  }
}
