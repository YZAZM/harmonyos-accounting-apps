import { router } from '@kit.ArkUI';
import { TransactionDao, Transaction, TransactionType, CategoryDao, Category } from '../data/Dao';
import { DateTimeUtil, MoneyUtil } from '../utils/Utils';

@Entry
@Component
struct TransactionList {
  @State transactions: Transaction[] = [];
  @State groupedTransactions: Map<string, Transaction[]> = new Map();
  @State isLoading: boolean = true;
  @State selectedMonth: number = new Date().getMonth() + 1;
  @State selectedYear: number = new Date().getFullYear();
  @State monthExpense: number = 0;
  @State monthIncome: number = 0;

  aboutToAppear() {
    this.loadData();
  }

  async loadData() {
    this.isLoading = true;
    
    // åŠ è½½å½“æœˆäº¤æ˜“
    const startDate = new Date(this.selectedYear, this.selectedMonth - 1, 1);
    const endDate = new Date(this.selectedYear, this.selectedMonth, 0, 23, 59, 59);
    
    this.transactions = await TransactionDao.queryByTimeRange(startDate.getTime(), endDate.getTime());
    
    // è®¡ç®—æœˆåº¦æ”¶æ”¯
    const summary = await TransactionDao.getMonthSummary(this.selectedYear, this.selectedMonth);
    this.monthExpense = summary.expense;
    this.monthIncome = summary.income;
    
    // æŒ‰æ—¥æœŸåˆ†ç»„
    this.groupTransactions();
    
    this.isLoading = false;
  }

  // æŒ‰æ—¥æœŸåˆ†ç»„äº¤æ˜“
  groupTransactions() {
    this.groupedTransactions.clear();
    
    for (const transaction of this.transactions) {
      const dateKey = DateTimeUtil.formatDate(transaction.transactionTime);
      const group = this.groupedTransactions.get(dateKey) || [];
      group.push(transaction);
      this.groupedTransactions.set(dateKey, group);
    }
  }

  // åˆ é™¤äº¤æ˜“
  async deleteTransaction(id: number) {
    await TransactionDao.delete(id);
    await this.loadData();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('ï¼œ')
          .fontSize(24)
          .fontColor('#666666')
          .onClick(() => {
            router.back();
          })
        
        Text('è´¦å•æ˜ç»†')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1A1A1A')
        
        Blank()
        
        Text('+')
          .fontSize(28)
          .fontColor('#4CAF50')
          .onClick(() => {
            router.pushUrl({ url: 'pages/AddTransaction' });
          })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })

      // æœˆä»½é€‰æ‹©å™¨
      Row() {
        Text('ï¼œ')
          .fontSize(20)
          .fontColor('#666666')
          .onClick(() => {
            this.selectedMonth--;
            if (this.selectedMonth < 1) {
              this.selectedMonth = 12;
              this.selectedYear--;
            }
            this.loadData();
          })
        
        Text(`${this.selectedYear}å¹´${this.selectedMonth}æœˆ`)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1A1A1A')
          .margin({ left: 16, right: 16 })
        
        Text('ï¼')
          .fontSize(20)
          .fontColor('#666666')
          .onClick(() => {
            this.selectedMonth++;
            if (this.selectedMonth > 12) {
              this.selectedMonth = 1;
              this.selectedYear++;
            }
            this.loadData();
          })
      }
      .width('100%')
      .height(48)
      .justifyContent(FlexAlign.Center)
      .backgroundColor('#FFFFFF')

      // æœˆåº¦æ±‡æ€»
      Row({ space: 24 }) {
        Column({ space: 4 }) {
          Text('æ”¶å…¥')
            .fontSize(12)
            .fontColor('#999999')
          Text(`Â¥${MoneyUtil.formatInt(this.monthIncome)}`)
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#4CAF50')
        }
        
        Divider()
          .vertical(true)
          .height(32)
          .color('#E0E0E0')
        
        Column({ space: 4 }) {
          Text('æ”¯å‡º')
            .fontSize(12)
            .fontColor('#999999')
          Text(`Â¥${MoneyUtil.formatInt(this.monthExpense)}`)
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#FF5722')
        }
        
        Divider()
          .vertical(true)
          .height(32)
          .color('#E0E0E0')
        
        Column({ space: 4 }) {
          Text('ç»“ä½™')
            .fontSize(12)
            .fontColor('#999999')
          Text(`Â¥${MoneyUtil.formatInt(this.monthIncome - this.monthExpense)}`)
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.monthIncome >= this.monthExpense ? '#4CAF50' : '#FF5722')
        }
      }
      .width('100%')
      .height(64)
      .backgroundColor('#FFFFFF')
      .justifyContent(FlexAlign.Center)
      .margin({ bottom: 8 })

      // äº¤æ˜“åˆ—è¡¨
      if (this.isLoading) {
        LoadingProgress()
          .width(40)
          .height(40)
          .margin({ top: 100 })
      } else if (this.transactions.length === 0) {
        Column({ space: 12 }) {
          Text('æœ¬æœˆæš‚æ— äº¤æ˜“')
            .fontSize(16)
            .fontColor('#999999')
          
          Button('è®°ä¸€ç¬”')
            .fontSize(14)
            .fontColor('#FFFFFF')
            .backgroundColor('#4CAF50')
            .borderRadius(20)
            .padding({ left: 24, right: 24 })
            .onClick(() => {
              router.pushUrl({ url: 'pages/AddTransaction' });
            })
        }
        .margin({ top: 100 })
      } else {
        List({ space: 8 }) {
          ForEach(Array.from(this.groupedTransactions.entries()), (group: [string, Transaction[]]) => {
            ListItem() {
              this.DayGroup(group[0], group[1])
            }
          }, (group: [string, Transaction[]]) => group[0])
        }
        .width('100%')
        .padding(16)
        .layoutWeight(1)
        .edgeEffect(EdgeEffect.Spring)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  DayGroup(dateKey: string, transactions: Transaction[]) {
    Column({ space: 0 }) {
      // æ—¥æœŸæ ‡é¢˜
      Row() {
        Column({ space: 2 }) {
          Text(dateKey)
            .fontSize(13)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1A1A1A')
          
          Text(DateTimeUtil.getWeekDay(new Date(dateKey).getTime()))
            .fontSize(11)
            .fontColor('#999999')
        }
        .alignItems(HorizontalAlign.Start)
        
        Blank()
        
        // è®¡ç®—å½“æ—¥æ”¶æ”¯
        Row({ space: 12 }) {
          let dayExpense = 0;
          let dayIncome = 0;
          for (const t of transactions) {
            if (t.type === TransactionType.EXPENSE) {
              dayExpense += t.amount;
            } else {
              dayIncome += t.amount;
            }
          }
          
          if (dayIncome > 0) {
            Text(`+${MoneyUtil.formatInt(dayIncome)}`)
              .fontSize(12)
              .fontColor('#4CAF50')
          }
          
          if (dayExpense > 0) {
            Text(`-${MoneyUtil.formatInt(dayExpense)}`)
              .fontSize(12)
              .fontColor('#FF5722')
          }
        }
      }
      .width('100%')
      .height(48)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FAFAFA')

      // äº¤æ˜“åˆ—è¡¨
      Column({ space: 0 }) {
        ForEach(transactions, (transaction: Transaction, index: number) => {
          this.TransactionItem(transaction, index === transactions.length - 1)
        }, (transaction: Transaction) => transaction.id?.toString())
      }
      .width('100%')
      .backgroundColor('#FFFFFF')
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .clip(true)
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 1
    })
  }

  @Builder
  TransactionItem(transaction: Transaction, isLast: boolean) {
    Row() {
      // å›¾æ ‡
      Column() {
        Text(this.getCategoryIcon(transaction.category))
          .fontSize(20)
      }
      .width(40)
      .height(40)
      .backgroundColor('#F5F5F5')
      .borderRadius(20)
      .justifyContent(FlexAlign.Center)
      .margin({ right: 12 })

      // ä¿¡æ¯
      Column({ space: 4 }) {
        Text(transaction.merchant || transaction.category)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1A1A1A')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
        
        Text(transaction.category)
          .fontSize(11)
          .fontColor('#999999')
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // é‡‘é¢
      Column({ space: 2 }) {
        Text(MoneyUtil.formatWithSymbol(transaction.amount, transaction.type))
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(transaction.type === TransactionType.EXPENSE ? '#1A1A1A' : '#4CAF50')
        
        Text(DateTimeUtil.formatTime(transaction.transactionTime))
          .fontSize(10)
          .fontColor('#CCCCCC')
      }
      .alignItems(HorizontalAlign.End)
    }
    .width('100%')
    .height(64)
    .padding({ left: 16, right: 16 })
    .border({
      width: { bottom: isLast ? 0 : 1 },
      color: '#F0F0F0'
    })
    .swipeAction({
      end: this.DeleteButton(transaction.id || 0)
    })
  }

  @Builder
  DeleteButton(id: number) {
    Row() {
      Text('åˆ é™¤')
        .fontSize(14)
        .fontColor('#FFFFFF')
    }
    .width(60)
    .height('100%')
    .backgroundColor('#FF5722')
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.deleteTransaction(id);
    })
  }

  private getCategoryIcon(category: string): string {
    const iconMap: Map<string, string> = new Map([
      ['é¤é¥®', 'ğŸ½ï¸'],
      ['äº¤é€š', 'ğŸš—'],
      ['è´­ç‰©', 'ğŸ›ï¸'],
      ['å¨±ä¹', 'ğŸ®'],
      ['å±…ä½', 'ğŸ '],
      ['åŒ»ç–—', 'ğŸ¥'],
      ['æ•™è‚²', 'ğŸ“š'],
      ['å·¥èµ„', 'ğŸ’°'],
      ['å¥–é‡‘', 'ğŸ'],
      ['æŠ•èµ„', 'ğŸ“ˆ'],
      ['å…¶ä»–', 'ğŸ“‹']
    ]);
    return iconMap.get(category) || 'ğŸ“‹';
  }
}
