import { window } from '@kit.ArkUI';
import { TransactionDao, Transaction, TransactionType } from '../data/Dao';
import { SmartCategorizer } from '../utils/SmartCategorizer';
import { MoneyUtil, DateTimeUtil } from '../utils/Utils';

// æ‚¬æµ®ç¡®è®¤çª—ç®¡ç†å™¨
export class FloatingWindowManager {
  private static instance: FloatingWindowManager;
  private floatingWindow: window.Window | null = null;
  private isShowing: boolean = false;
  private currentPaymentInfo: PaymentInfo | null = null;

  static getInstance(): FloatingWindowManager {
    if (!FloatingWindowManager.instance) {
      FloatingWindowManager.instance = new FloatingWindowManager();
    }
    return FloatingWindowManager.instance;
  }

  // åˆ›å»ºæ‚¬æµ®çª—
  async createFloatingWindow(): Promise<void> {
    if (this.floatingWindow) {
      return;
    }

    try {
      // åˆ›å»ºæ‚¬æµ®çª—çª—å£
      this.floatingWindow = await window.createWindow({
        name: 'AutoRecordConfirmWindow',
        windowType: window.WindowType.TYPE_FLOAT,
        ctx: getContext()
      });

      // è®¾ç½®çª—å£å±æ€§
      await this.floatingWindow.setWindowLayoutFullScreen(false);
      await this.floatingWindow.setWindowBackgroundColor('#00000000');
      
      // è®¾ç½®çª—å£å¤§å°å’Œä½ç½®
      const displayInfo = await window.getLastWindow(getContext()).getWindowProperties();
      const windowWidth = 320;
      const windowHeight = 280;
      const posX = (displayInfo.windowRect.width - windowWidth) / 2;
      const posY = 120;

      await this.floatingWindow.moveWindowTo(posX, posY);
      await this.floatingWindow.resize(windowWidth, windowHeight);
      
      console.info('æ‚¬æµ®çª—åˆ›å»ºæˆåŠŸ');
    } catch (err) {
      console.error('åˆ›å»ºæ‚¬æµ®çª—å¤±è´¥:', JSON.stringify(err));
    }
  }

  // æ˜¾ç¤ºç¡®è®¤çª—å£
  async showConfirmWindow(paymentInfo: PaymentInfo): Promise<void> {
    if (this.isShowing) {
      return;
    }

    this.currentPaymentInfo = paymentInfo;
    this.isShowing = true;

    try {
      await this.createFloatingWindow();
      
      if (!this.floatingWindow) {
        return;
      }

      // åŠ è½½UIå†…å®¹
      // å®é™…å®ç°éœ€è¦ç»‘å®šUIç»„ä»¶
      await this.floatingWindow.showWindow();
      
      // 3ç§’åè‡ªåŠ¨éšè—
      setTimeout(() => {
        this.hideWindow();
      }, 3000);

    } catch (err) {
      console.error('æ˜¾ç¤ºæ‚¬æµ®çª—å¤±è´¥:', JSON.stringify(err));
      this.isShowing = false;
    }
  }

  // éšè—çª—å£
  async hideWindow(): Promise<void> {
    if (!this.floatingWindow || !this.isShowing) {
      return;
    }

    try {
      await this.floatingWindow.hideWindow();
      this.isShowing = false;
      this.currentPaymentInfo = null;
    } catch (err) {
      console.error('éšè—æ‚¬æµ®çª—å¤±è´¥:', JSON.stringify(err));
    }
  }

  // ç¡®è®¤è®°è´¦
  async confirmRecord(modifiedInfo?: Partial<PaymentInfo>): Promise<void> {
    if (!this.currentPaymentInfo) {
      return;
    }

    const info = { ...this.currentPaymentInfo, ...modifiedInfo };
    
    const transaction: Transaction = {
      amount: info.amount,
      type: TransactionType.EXPENSE,
      category: info.category,
      merchant: info.merchant,
      transactionTime: info.time,
      remark: info.remark,
      sourceApp: info.sourceApp
    };

    try {
      const id = await TransactionDao.add(transaction);
      console.info(`ç¡®è®¤è®°è´¦æˆåŠŸï¼ŒID: ${id}`);
      this.hideWindow();
    } catch (err) {
      console.error('ç¡®è®¤è®°è´¦å¤±è´¥:', JSON.stringify(err));
    }
  }

  // å–æ¶ˆè®°è´¦
  cancelRecord(): void {
    console.info('ç”¨æˆ·å–æ¶ˆè®°è´¦');
    this.hideWindow();
  }

  // é”€æ¯æ‚¬æµ®çª—
  async destroy(): Promise<void> {
    await this.hideWindow();
    if (this.floatingWindow) {
      await this.floatingWindow.destroyWindow();
      this.floatingWindow = null;
    }
  }
}

// æ”¯ä»˜ä¿¡æ¯æ¥å£
interface PaymentInfo {
  amount: number;
  merchant: string;
  category: string;
  time: number;
  sourceApp: string;
  remark?: string;
}

// æ‚¬æµ®ç¡®è®¤çª—UIç»„ä»¶
@Component
export struct ConfirmFloatingWindow {
  @Prop amount: number = 0;
  @Prop merchant: string = '';
  @Prop category: string = 'å…¶ä»–';
  @Prop sourceApp: string = '';
  @State selectedCategory: string = '';
  @State remark: string = '';
  @State showCategoryPicker: boolean = false;

  private categories: string[] = ['é¤é¥®', 'äº¤é€š', 'è´­ç‰©', 'å¨±ä¹', 'å±…ä½', 'åŒ»ç–—', 'æ•™è‚²', 'å…¶ä»–'];

  aboutToAppear() {
    this.selectedCategory = this.category;
  }

  build() {
    Column({ space: 0 }) {
      // æ ‡é¢˜æ 
      Row({ space: 8 }) {
        Text('ğŸ’°')
          .fontSize(20)
        
        Text('æ£€æµ‹åˆ°ä¸€ç¬”æ”¯å‡º')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1A1A1A')
        
        Blank()
        
        Text('Ã—')
          .fontSize(24)
          .fontColor('#999999')
          .onClick(() => {
            FloatingWindowManager.getInstance().cancelRecord();
          })
      }
      .width('100%')
      .height(48)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#F5F5F5')

      // é‡‘é¢
      Column({ space: 4 }) {
        Text(`Â¥${MoneyUtil.format(this.amount)}`)
          .fontSize(32)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FF5722')
        
        if (this.merchant) {
          Text(this.merchant)
            .fontSize(14)
            .fontColor('#666666')
        }
      }
      .width('100%')
      .padding(16)

      // åˆ†ç±»é€‰æ‹©
      Row({ space: 8 }) {
        Text('åˆ†ç±»ï¼š')
          .fontSize(14)
          .fontColor('#666666')
        
        Row({ space: 4 }) {
          Text(this.getCategoryIcon(this.selectedCategory))
            .fontSize(16)
          
          Text(this.selectedCategory)
            .fontSize(14)
            .fontColor('#1A1A1A')
        }
        .padding({ left: 12, right: 12, top: 6, bottom: 6 })
        .backgroundColor('#F0F0F0')
        .borderRadius(16)
        .onClick(() => {
          this.showCategoryPicker = true;
        })
        
        Blank()
      }
      .width('100%')
      .padding({ left: 16, right: 16 })

      // å¤‡æ³¨è¾“å…¥
      Row({ space: 8 }) {
        Text('å¤‡æ³¨ï¼š')
          .fontSize(14)
          .fontColor('#666666')
        
        TextInput({ placeholder: 'æ·»åŠ å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰', text: $$this.remark })
          .fontSize(14)
          .placeholderColor('#CCCCCC')
          .backgroundColor('#F5F5F5')
          .borderRadius(8)
          .height(36)
          .layoutWeight(1)
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 16 })

      // æŒ‰é’®ç»„
      Row({ space: 12 }) {
        Button('å¿½ç•¥')
          .fontSize(14)
          .fontColor('#666666')
          .backgroundColor('#F5F5F5')
          .layoutWeight(1)
          .onClick(() => {
            FloatingWindowManager.getInstance().cancelRecord();
          })
        
        Button('âœ“ ç¡®è®¤è®°è´¦')
          .fontSize(14)
          .fontColor('#FFFFFF')
          .backgroundColor('#4CAF50')
          .layoutWeight(2)
          .onClick(() => {
            FloatingWindowManager.getInstance().confirmRecord({
              category: this.selectedCategory,
              remark: this.remark
            });
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 16 })
    }
    .width(320)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .shadow({
      radius: 16,
      color: 'rgba(0,0,0,0.2)',
      offsetX: 0,
      offsetY: 4
    })
  }

  private getCategoryIcon(category: string): string {
    const iconMap: Map<string, string> = new Map([
      ['é¤é¥®', 'ğŸ½ï¸'],
      ['äº¤é€š', 'ğŸš—'],
      ['è´­ç‰©', 'ğŸ›ï¸'],
      ['å¨±ä¹', 'ğŸ®'],
      ['å±…ä½', 'ğŸ '],
      ['åŒ»ç–—', 'ğŸ¥'],
      ['æ•™è‚²', 'ğŸ“š'],
      ['å…¶ä»–', 'ğŸ“‹']
    ]);
    return iconMap.get(category) || 'ğŸ“‹';
  }
}

export default FloatingWindowManager.getInstance();
